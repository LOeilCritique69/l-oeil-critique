name: ðŸŽ¬ MAJ Automatique â€” Bandes Annonces

on:
  schedule:
    # ExÃ©cution 3 fois par jour (horaires France mÃ©tropolitaine)
    - cron: '0 7 * * *'   # 09h00 heure franÃ§aise (UTC+2 Ã©tÃ© / UTC+1 hiver)
    - cron: '0 13 * * *'  # 15h00 heure franÃ§aise
    - cron: '0 19 * * *'  # 21h00 heure franÃ§aise
  workflow_dispatch:      # Permet un dÃ©clenchement manuel depuis l'interface GitHub
  push:
    branches:
      - main
    paths:
      - 'l_oeil_critique/scripts/scraper_bandes_annonces.py'
      - 'requirements.txt'
      - '.github/workflows/*.yml'

# Ã‰vite les exÃ©cutions concurrentes
concurrency:
  group: bandes-annonces-update
  cancel-in-progress: true

jobs:
  update-content:
    runs-on: ubuntu-latest
    timeout-minutes: 15  # Limite le temps d'exÃ©cution
    
    permissions:
      contents: write  # NÃ©cessaire pour pousser les changements

    steps:
      - name: â¬‡ï¸ Cloner le dÃ©pÃ´t
        uses: actions/checkout@v4  # Version plus rÃ©cente
        with:
          token: ${{ secrets.GH_TOKEN_2 }}
          fetch-depth: 0  # Clone complet pour l'historique Git

      - name: ðŸ Configurer Python
        uses: actions/setup-python@v5  # Version plus rÃ©cente
        with:
          python-version: '3.11'
          cache: 'pip'  # Cache les dÃ©pendances pip pour accÃ©lÃ©rer

      - name: ðŸ“¦ Installer les dÃ©pendances
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
          
      - name: ðŸŽ­ Installer Playwright
        run: |
          python -m playwright install --with-deps chromium
          
      - name: ðŸ” VÃ©rifier l'environnement
        run: |
          echo "Python version: $(python --version)"
          echo "Pip version: $(pip --version)"
          pip list | grep -E "(requests|beautifulsoup4|playwright)"
          
      - name: ðŸŽ¬ ExÃ©cuter le scraper
        id: scraper
        run: |
          echo "ðŸš€ DÃ©marrage du scraping..."
          python l_oeil_critique/scripts/scraper_bandes_annonces.py
          echo "âœ… Scraping terminÃ©"
        continue-on-error: false  # Stopper si le script Ã©choue
        
      - name: ðŸ“Š VÃ©rifier les changements
        id: check_changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "âœ… Changements dÃ©tectÃ©s"
            git status --short
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Aucun changement dÃ©tectÃ©"
          fi

      - name: ðŸ”§ Configurer Git
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"

      - name: ðŸ” Commit et push automatique
        if: steps.check_changes.outputs.changes == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5  # Version plus rÃ©cente
        with:
          commit_message: "ðŸŽ¬ MAJ automatique â€” Bandes Annonces (${{ github.run_number }})"
          commit_user_name: github-actions[bot]
          commit_user_email: github-actions[bot]@users.noreply.github.com
          branch: main
          file_pattern: |
            l_oeil_critique/scripts/bande_annonces_log.json
            l_oeil_critique/scripts/scraper.log
            bande_annonces_blocs.html
            bande_annonces_maj.html
          commit_options: '--no-verify'
          skip_dirty_check: false
          skip_fetch: false
          skip_checkout: false
          disable_globbing: false
          create_branch: false
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN_2 }}

      - name: ðŸ“ RÃ©sumÃ© de l'exÃ©cution
        if: always()
        run: |
          echo "## ðŸ“Š RÃ©sumÃ© du Workflow" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Statut** : ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Changements dÃ©tectÃ©s** : ${{ steps.check_changes.outputs.changes || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Date** : $(date +'%d/%m/%Y %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "- **NumÃ©ro d'exÃ©cution** : ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          
      - name: ðŸ“¤ Upload des logs (en cas d'erreur)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: scraper-logs-${{ github.run_number }}
          path: |
            l_oeil_critique/scripts/scraper.log
            l_oeil_critique/scripts/bande_annonces_log.json
          retention-days: 7

      - name: ðŸš¨ Notifier en cas d'Ã©chec
        if: failure()
        run: |
          echo "::error::Le workflow a Ã©chouÃ©. Consultez les logs pour plus de dÃ©tails."
          echo "::error::VÃ©rifiez les artifacts uploadÃ©s pour analyser l'erreur."